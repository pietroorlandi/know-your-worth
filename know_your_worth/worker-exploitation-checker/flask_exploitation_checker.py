from flask import Flask, request, jsonify
import os

from know_your_worth.rag.rag_engine import RAGEngine
from know_your_worth.utils.os_utils import read_yaml_file
from utils import get_prompt_exploitation_checker


app = Flask(__name__)
rag_engine_exploitation_checker = RAGEngine(
    db_dir="./index/ccnl",
    collection_name="ccnl",
    llm_api_key=os.getenv("SONAR_API_KEY"),
    llm_model=os.getenv("SONAR_API_MODEL"),
)


@app.route('/check_exploitation', methods=['POST'])
def check_exploitation():
    data = request.get_json()
    questionnaire_schema = data.get("questionnaire_schema")
    worker_answers = data.get("worker_answers")
    follow_up_questions = data.get("follow_up_questions")
    follow_up_answers = data.get("follow_up_answers")
    prompt = get_prompt_exploitation_checker(
        questionnaire_schema,
        worker_answers,
        follow_up_questions,
        follow_up_answers
    )
    try:
        result = rag_engine_exploitation_checker.query(prompt=prompt)
        print(f"result: {result} - type: {type(result)}")
        # Estrai il testo della risposta
        if hasattr(result, 'response'):
            response_text = str(result.response)
        else:
            response_text = str(result)
        return jsonify({"result": response_text}), 200
    except Exception as e:
        print(f"Errore durante la query: {e}")
        return jsonify({"error": "Errore interno del server"}), 500

config = read_yaml_file("configs.yaml")

if __name__ == '__main__':
    app.run(debug=True, host=config["flask_check_exploitation"]["host"], port=config["flask_check_exploitation"]["port"])